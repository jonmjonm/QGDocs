<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.21">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Cycle Walk â€“ Quantifying Gerrymandering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea1d7ac60288e0f1efdbc993fd8432ae.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-7ebee9d6e4f766fb7fb926431a00ecf2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Quantifying Gerrymandering</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./geographic.html"> 
<span class="menu-text">Geographic Files</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./cycleWalk.html"> 
<span class="menu-text">Cycle Walk</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./forest_recom.html"> 
<span class="menu-text">Metropolized Forest RECOM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./atlasIO.html"> 
<span class="menu-text">Atlas Files</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://sites.duke.edu/quantifyinggerrymandering/"> 
<span class="menu-text">QG Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cycleWalk.html">Cycle Walk</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./geographic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geographic Files</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cycleWalk.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Cycle Walk</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./forest_recom.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metropolized Forest ReCom</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./atlasIO.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Atlas Files</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#the-metropolized-cycle-walk-algorithm" id="toc-the-metropolized-cycle-walk-algorithm" class="nav-link" data-scroll-target="#the-metropolized-cycle-walk-algorithm">The Metropolized Cycle Walk Algorithm</a></li>
  <li><a href="#instillation" id="toc-instillation" class="nav-link" data-scroll-target="#instillation">Instillation</a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a>
  <ul class="collapse">
  <li><a href="#a-first-example-4x4-rectangular-grid" id="toc-a-first-example-4x4-rectangular-grid" class="nav-link" data-scroll-target="#a-first-example-4x4-rectangular-grid">A first example: 4x4 rectangular grid</a></li>
  <li><a href="#a-second-example-10x10-hexagonal-grid" id="toc-a-second-example-10x10-hexagonal-grid" class="nav-link" data-scroll-target="#a-second-example-10x10-hexagonal-grid">A second example: 10x10 hexagonal grid</a></li>
  <li><a href="#a-small-realistic-example-connecticut-congressional-districts." id="toc-a-small-realistic-example-connecticut-congressional-districts." class="nav-link" data-scroll-target="#a-small-realistic-example-connecticut-congressional-districts.">A small realistic example: Connecticut Congressional Districts.</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Cycle Walk</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>CycleWalk.jl is a registered Julia package that implements the Metropolized Cycle Walk algorithm which is used to sample a used specified distribution on the space of political redistricting plans. This MCMC algorithm is used to create ensemble of redistricting plans that can be used to analyze the impact of different redistricting plans on electoral outcomes.</p>
<p>Metropolized Cycle Walk supports number of different score/energy functions which are used to define the distribution. The distribution encodes the legal and policy preferences.</p>
<p>Metropolized Cycle Walk outputs the sampled redistricting into an Atlas file. AtlasIO files can be loaded using Julia or Python using the AtlasIO.jl library.</p>
</section>
<section id="the-metropolized-cycle-walk-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="the-metropolized-cycle-walk-algorithm">The Metropolized Cycle Walk Algorithm</h2>
<p>The basic Cycle Walk produced <span class="math inline">\(d\)</span>-tree spanning forests where each of the <span class="math inline">\(d\)</span>-spanning trees is approximately balanced in the sense that the total population of each tree is approximately balanced.</p>
<p>One step of the Cycle Walk proceeds by either proposing a 1-Tree Cycle Walk or a 2-Tree Cycle Walk. The 1-Tree Cycle Walk adds an edge the tree and then removes and edge from cycle this addition creates so that one again has a tree. The 2-Tree Cycle Walk adds two edges between two adjacent trees and then removes two edges from the cycle these additions creates so that one again has two trees.</p>
<p>The Metropolized Cycle Walk algorithm uses these walks as proposals to a Metropolis-Hastings algorithm to sample from a specified target distribution.</p>
<p>More details on the algorithm can be found in the [Cycle Walk paper].</p>
</section>
<section id="instillation" class="level2">
<h2 class="anchored" data-anchor-id="instillation">Instillation</h2>
<p>The latest released version of the `CycleWalk.jlâ€™ package can be installed from with in Julia by</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Pkg</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"CycleWalk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This can be done from the commandline in a terminal with</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">julia</span> <span class="at">-e</span> <span class="st">'using Pkg; Pkg.add("CycleWalk")'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="local-environments" class="level4">
<h4 class="anchored" data-anchor-id="local-environments">Local Environments</h4>
<p>It is recommended that you run your Julia session in a local environment to minimize unanticipated side effects from other (unneeded) packages. To add the CycleWalk package to a local environment in the current working directory</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Pkg</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">activate</span>(<span class="st">"."</span>)       <span class="co"># replace this path to keep the local </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># environment somewhere else or with a specified name </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"CycleWalk"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="examples" class="level2">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<p>In each example, we will step through the commands task by task. At the end of the section we will collect all of the commands into a complete script you can copy and execute.</p>
<section id="a-first-example-4x4-rectangular-grid" class="level3">
<h3 class="anchored" data-anchor-id="a-first-example-4x4-rectangular-grid">A first example: 4x4 rectangular grid</h3>
<p>Our first example will be on a small 4x4 rectangular graph. We choose this example because it executes fast and produces relatively small files. that can be examined by hand. The first step is to download the needed JSON adjacency file. For this example it is call <a href="Geo/Adjacency/grid_graph_4_by_4.json">grid_graph_4_by_4.json</a> and was discussed more fully in <a href="geographic.html#sec-json-adjacency-files">this Section on JSON Adjacency Files</a>. You can download the file to current directory using the following commandline at the terminal</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span>   https://jonmjonm.github.io/QGDocs/Geo/Adjacency/grid_graph_4_by_4.json <span class="at">-o</span> grid_graph_4_by_4.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now that we have the needed JSON adjacency file, open a Julia session in the directory with that datafile. We begin by activating out local environment where we have installed the CycleWalk Package and loading the <code>CycleWalk</code> and <code>RandomNumbers</code> packages. If you have not installed the <code>RandomNumbers</code> package you need to execute <code>Pkg.add("RandomNumbers")</code> in a julia window. Make sure you have already activated the environment you intend to use.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Pkg</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">activate</span>(<span class="st">"."</span>)       <span class="co">#   activate environment </span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RandomNumbers</span>     <span class="co">#   load Random Number package</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CycleWalk</span>         <span class="co">#   load Cycle Walk package</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="build-the-graph" class="level4">
<h4 class="anchored" data-anchor-id="build-the-graph">Build the Graph</h4>
<p>To load the graph we begin by setting the path to the adjacency file; called <code>grid_graph_4_by_4.json</code> in this case. Next we create a set holding all of the variable names we want to load from the adjacency file. Lastly, we build the graph by specifying the file name, the variable that holds th population and the nodes names, and all of the node data you want load. You need to specify which of the node data names hold the area, border length, and edge parameter data.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">## build graph</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>pctGraphPath <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"."</span>,<span class="st">"grid_graph_4_by_4.json"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>nodeData <span class="op">=</span> <span class="fu">Set</span>([<span class="st">"node_name"</span>, <span class="st">"county"</span>, <span class="st">"population"</span>, <span class="st">"area"</span>, <span class="st">"border_length"</span>]);</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> <span class="fu">build_graph</span>(pctGraphPath, <span class="st">"population"</span>, <span class="st">"node_name"</span>, nodeData;</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>              area_col<span class="op">=</span><span class="st">"area"</span>, node_border_col<span class="op">=</span><span class="st">"border_length"</span>, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>              edge_perimeter_col<span class="op">=</span><span class="st">"length"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The variable <code>graph</code> is a structure that contains all of the adjacency data as well as all of the data on the vertices and edges.</p>
</section>
<section id="initialize-a-random-forest-partitions-with-specified-constraints" class="level4">
<h4 class="anchored" data-anchor-id="initialize-a-random-forest-partitions-with-specified-constraints">Initialize a random Forest Partitions with specified Constraints</h4>
<p>We now define the constraints on the phasespace. We specify the number of connected districts in our forest partition. We will use the term <em>Forest Partition</em> with <span class="math inline">\(d\)</span> elements to describe a spanning forest with <span class="math inline">\(d\)</span> disjoint spanning trees. The vertices/nodes in each spanning tree will be the elements of the partition of vertices/nodes induced by the <em>Forest Partition</em>. Beyond the number of constraints, in this case we will also add an absolute constraint on the population deviation. We will require all partitions (also referred to as distractings) to have elements whose relative population deviation from the ideal population is less than <code>allowed_pop_dev</code>. The ideal population is calculated by <span class="math display">\[\text{Ideal Population}=\frac{\text{Total Population}}{\text{Number of Districts}}\]</span> then the relative population deviation of the <span class="math inline">\(i\)</span>th district is given by <span class="math display">\[ \text{$i$th relative population deviation}= \frac{\big|\text{$i$th District Population} - \text{Ideal Population}\big|}{\text{Ideal Population}}\]</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>num_of_districts<span class="op">=</span><span class="fl">2</span>              <span class="co"># Number of districts</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>allowed_pop_dev<span class="op">=</span><span class="fl">0.05</span>            <span class="co"># population deviation (fraction from ideal)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize constraints </span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>constraints <span class="op">=</span> <span class="fu">initialize_constraints</span>()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># add population constraint </span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">add_constraint!</span>(constraints, <span class="fu">PopulationConstraint</span>(graph, num_of_districts, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                                                    allowed_pop_dev))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize a random initial partition</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> PCG.<span class="fu">PCGStateOneseq</span>(<span class="dt">UInt64</span>, <span class="fl">4541901234</span>)    <span class="co"># initialize a random number generator </span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>partition <span class="op">=</span> <span class="fu">LinkCutPartition</span>(graph, constraints, num_of_districts; rng<span class="op">=</span>rng, </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                                verbose<span class="op">=</span><span class="cn">true</span>);</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>There are other choices of constraints one can introduce which we will discuss later. The <code>LinkCutPartition</code> function tries to generate though a random algorithm a partition with <code>num_of_districts</code> districts that satisfies the specified constraints. It tires up to on the order of 100 times and returns the first acceptable partition generated. If all of the attempts fail, it throws an error message.</p>
</section>
<section id="sec-define-measure" class="level4">
<h4 class="anchored" data-anchor-id="sec-define-measure">Defining the Measure</h4>
<p>Next we define the target measure we want to sample from. In this simple example we will only consider <em>log spanning forest</em> energy that we will denote by <span class="math inline">\(h(\xi)\)</span> for a given partition <span class="math inline">\(\xi\)</span>. It is defined by <span class="math inline">\(h(\xi)=\log \text{Tree}(\xi)\)</span> where <span class="math inline">\(\text{Tree}(\xi)\)</span> is the number spanning forest which induce the given partition <span class="math inline">\(\xi\)</span>. When the parameter <span class="math inline">\(\gamma\)</span> bellow is taken to be zero then the measure is uniform on spanning forests while <span class="math inline">\(\gamma=1\)</span> corresponds to uniform on partitions. Normally, it is not wise to consider the uniform measure on partitions without an isoparmetric energy in the measure. However on a small graph like this, it does not matter.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>measure <span class="op">=</span> <span class="fu">Measure</span>()     <span class="co"># build measure</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>gamma<span class="op">=</span><span class="fl">0.0</span>               <span class="co"># typically a number in [0,1]</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">push_energy!</span>(measure, get_log_spanning_forests, gamma) <span class="co"># add spanning forests energy</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="build-the-proposal-for-metropolishastings-mcmc" class="level4">
<h4 class="anchored" data-anchor-id="build-the-proposal-for-metropolishastings-mcmc">Build the Proposal for Metropolisâ€“Hastings MCMC</h4>
<p>We now build the Markov Chain that will be used as a proposal in a <a href="https://en.wikipedia.org/wiki/Metropolis%E2%80%93Hastings_algorithm">Metropolisâ€“Hastings</a> Algorithm to construct a markov chains guaranteed to have the measure constructed <a href="#sec-define-measure">above</a> as a stationary measure.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>cycle_walk_2_tree <span class="op">=</span> <span class="fu">build_two_tree_cycle_walk</span>(constraints)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>cycle_walk_1_tree <span class="op">=</span> <span class="fu">build_one_tree_cycle_walk</span>(constraints)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>twocycle_frac<span class="op">=</span><span class="fl">0.1</span>   <span class="co"># fraction of 2-tree cycle walks among total walks</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>proposal <span class="op">=</span> [(twocycle_frac, cycle_walk_2_tree), </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            (<span class="fl">1.0</span><span class="op">-</span>twocycle_frac, cycle_walk_1_tree)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="choose-the-output" class="level4">
<h4 class="anchored" data-anchor-id="choose-the-output">Choose the Output</h4>
<p>We now establish the name of the output file as well as fix a few parameters we want to be written to the file in addition to the vertex/node assignment that makes the current partition.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>atlasName <span class="op">=</span> <span class="st">"cycleWalk"</span><span class="op">*</span><span class="st">"_grid4x4_"</span> <span class="op">*</span> <span class="st">"_gamma"</span> <span class="op">*</span> <span class="fu">string</span>(gamma)<span class="op">*</span><span class="st">"_kappa"</span><span class="fu">*string</span>(twocycle_frac) <span class="op">*</span><span class="st">".jsonl"</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>output_file_path <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"output"</span>,<span class="st">"grid"</span>, atlasName) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Next we construct a map writer that will output the current districting as well as some selected statistics about the districting and the run so far.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ad_param <span class="op">=</span> <span class="fu">Dict</span><span class="dt">{String, Any}</span>(<span class="st">"popdev"</span> <span class="op">=&gt;</span> allowed_pop_dev)   <span class="co"># specific info to write</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> <span class="fu">Writer</span>(measure, constraints, partition, output_file_path; </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                additional_parameters<span class="op">=</span>ad_param)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_log_spanning_trees)        <span class="co"># add spanning trees count to writer</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_log_spanning_forests)      <span class="co"># add spanning forests count to writer</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_isoperimetric_scores)      <span class="co"># add isoperimetric scores to writer</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="run-the-markov-chain" class="level4">
<h4 class="anchored" data-anchor-id="run-the-markov-chain">Run the Markov Chain</h4>
<p>We now run the metropolized Cycle Walk with the proposal we constructed above.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>cycle_walk_2_tree_steps <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>steps <span class="op">=</span> <span class="fu">Int</span>(cycle_walk_2_tree_steps<span class="op">/</span>twocycle_frac)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>outfreq <span class="op">=</span> <span class="fu">Int</span>(<span class="fl">1</span><span class="op">/</span>twocycle_frac)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"running mcmc; outputting here: "</span><span class="op">*</span> output_file_path)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">run_metropolis_hastings!</span>(partition, proposal, measure, steps, rng,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                         writer<span class="op">=</span>writer, output_freq<span class="op">=</span>outfreq)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">close_writer</span>(writer) <span class="co"># close atlas</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="putting-everything-together" class="level4">
<h4 class="anchored" data-anchor-id="putting-everything-together">Putting Everything Together</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Pkg</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">activate</span>(<span class="st">"."</span>)       <span class="co">#   activate environment </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RandomNumbers</span>     <span class="co">#   load Random Number package</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CycleWalk</span>         <span class="co">#   load Cycle Walk package</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">## build graph</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>pctGraphPath <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"."</span>,<span class="st">"grid_graph_4_by_4.json"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>nodeData <span class="op">=</span> <span class="fu">Set</span>([<span class="st">"node_name"</span>, <span class="st">"county"</span>, <span class="st">"population"</span>, <span class="st">"area"</span>, <span class="st">"border_length"</span>]);</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> <span class="fu">build_graph</span>(pctGraphPath, <span class="st">"population"</span>, <span class="st">"node_name"</span>, nodeData;</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>              area_col<span class="op">=</span><span class="st">"area"</span>, node_border_col<span class="op">=</span><span class="st">"border_length"</span>, </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>              edge_perimeter_col<span class="op">=</span><span class="st">"length"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>num_of_districts<span class="op">=</span><span class="fl">2</span>              <span class="co"># Number of districts</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>allowed_pop_dev<span class="op">=</span><span class="fl">0.05</span>            <span class="co"># population deviation (fraction from ideal)</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize constraints </span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>constraints <span class="op">=</span> <span class="fu">initialize_constraints</span>()</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co"># add population constraint </span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="fu">add_constraint!</span>(constraints, <span class="fu">PopulationConstraint</span>(graph, num_of_districts, </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>                                                    allowed_pop_dev))</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize a random initial partition</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> PCG.<span class="fu">PCGStateOneseq</span>(<span class="dt">UInt64</span>, <span class="fl">4541901234</span>)    <span class="co"># initialize a random number generator </span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>partition <span class="op">=</span> <span class="fu">LinkCutPartition</span>(graph, constraints, num_of_districts; rng<span class="op">=</span>rng, </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>                                verbose<span class="op">=</span><span class="cn">true</span>);</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>measure <span class="op">=</span> <span class="fu">Measure</span>()     <span class="co"># build measure</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>gamma<span class="op">=</span><span class="fl">0.0</span>               <span class="co"># typically a number in [0,1]</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="fu">push_energy!</span>(measure, get_log_spanning_forests, gamma) <span class="co"># add spanning forests energy</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>cycle_walk_2_tree <span class="op">=</span> <span class="fu">build_two_tree_cycle_walk</span>(constraints)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>cycle_walk_1_tree <span class="op">=</span> <span class="fu">build_one_tree_cycle_walk</span>(constraints)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>twocycle_frac<span class="op">=</span><span class="fl">0.1</span>   <span class="co"># fraction of 2-tree cycle walks among total walks</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>proposal <span class="op">=</span> [(twocycle_frac, cycle_walk_2_tree), </span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            (<span class="fl">1.0</span><span class="op">-</span>twocycle_frac, cycle_walk_1_tree)]</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="co">#set output file name</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>atlasName <span class="op">=</span> <span class="st">"cycleWalk"</span><span class="op">*</span><span class="st">"_grid4x4_"</span> <span class="op">*</span> <span class="st">"_gamma"</span> <span class="op">*</span> <span class="fu">string</span>(gamma)<span class="op">*</span><span class="st">"_kappa"</span><span class="fu">*string</span>(twocycle_frac) <span class="op">*</span><span class="st">".jsonl"</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>output_file_path <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"output"</span>,<span class="st">"grid"</span>, atlasName) </span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co"># create writer and open output atlas</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>ad_param <span class="op">=</span> <span class="fu">Dict</span><span class="dt">{String, Any}</span>(<span class="st">"popdev"</span> <span class="op">=&gt;</span> allowed_pop_dev)   <span class="co"># specific info to write</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> <span class="fu">Writer</span>(measure, constraints, partition, output_file_path; </span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>                additional_parameters<span class="op">=</span>ad_param)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_log_spanning_trees)        <span class="co"># add spanning trees count to writer</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_log_spanning_forests)      <span class="co"># add spanning forests count to writer</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_isoperimetric_scores)      <span class="co"># add isoperimetric scores to writer</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the MCMC</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>cycle_walk_2_tree_steps <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>steps <span class="op">=</span> <span class="fu">Int</span>(cycle_walk_2_tree_steps<span class="op">/</span>twocycle_frac)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>outfreq <span class="op">=</span> <span class="fu">Int</span>(<span class="fl">1</span><span class="op">/</span>twocycle_frac)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"running mcmc; outputting here: "</span><span class="op">*</span> output_file_path)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="fu">run_metropolis_hastings!</span>(partition, proposal, measure, steps, rng,</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>                         writer<span class="op">=</span>writer, output_freq<span class="op">=</span>outfreq)</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="fu">close_writer</span>(writer) <span class="co"># close atlas</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="a-second-example-10x10-hexagonal-grid" class="level3">
<h3 class="anchored" data-anchor-id="a-second-example-10x10-hexagonal-grid">A second example: 10x10 hexagonal grid</h3>
<p>We now consider a small variation on our previous example. We consider a planner region with a regular triangulation. The dual/adjacency graph is a hexagonal lattice. We begin by downloading the needed JSON adjacency file to our current directory.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span>  https://jonmjonm.github.io/QGDocs/Geo/Adjacency/hex_graph_10_by_10.json <span class="at">-o</span> hex_graph_10_by_10.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="a-modified-script" class="level4">
<h4 class="anchored" data-anchor-id="a-modified-script">A Modified Script</h4>
<p>We now give code to run on the 10x10 hexagonal lattice. It will only require some small modifications from the previous example given above. Beyond the obvious such as modifying the input and output files, we will also increase the number of districts to 4 and decrease the allowed population deviation. This last step is possible as the number of element in each district increases providing finer granularity. We will also introduce an isodiametric score in the target measure to keep the districts compact no matter what constant is placed in front of the log spanning forests term in the energy. Recall that as that constant goes to one, the log spanning forests energy causes the probability measure to converge to the uniform measure on partitions if no other weights are used. The uniform measure on partitions is full of space-filling partitions that are very, very non-compact.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1"></a><span class="im">using</span> <span class="bu">Pkg</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="bu">Pkg</span>.<span class="fu">activate</span>(<span class="st">"."</span>)       <span class="co">#   activate environment </span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="im">using</span> <span class="bu">RandomNumbers</span>     <span class="co">#   load Random Number package</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="im">using</span> <span class="bu">CycleWalk</span>         <span class="co">#   load Cycle Walk package</span></span>
<span id="cb16-5"><a href="#cb16-5"></a></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co">## build graph</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>pctGraphPath <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"."</span>,<span class="st">"hex_graph_10_by_10.json"</span>)</span>
<span id="cb16-8"><a href="#cb16-8"></a>nodeData <span class="op">=</span> <span class="fu">Set</span>([<span class="st">"node_name"</span>, <span class="st">"county"</span>, <span class="st">"population"</span>, <span class="st">"area"</span>, <span class="st">"border_length"</span>]);</span>
<span id="cb16-9"><a href="#cb16-9"></a>graph <span class="op">=</span> <span class="fu">build_graph</span>(pctGraphPath, <span class="st">"population"</span>, <span class="st">"node_name"</span>, nodeData;</span>
<span id="cb16-10"><a href="#cb16-10"></a>              area_col<span class="op">=</span><span class="st">"area"</span>, node_border_col<span class="op">=</span><span class="st">"border_length"</span>, </span>
<span id="cb16-11"><a href="#cb16-11"></a>              edge_perimeter_col<span class="op">=</span><span class="st">"length"</span>)</span>
<span id="cb16-12"><a href="#cb16-12"></a></span>
<span id="cb16-13"><a href="#cb16-13"></a>num_of_districts<span class="op">=</span><span class="fl">5</span>              <span class="co"># Number of districts</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>allowed_pop_dev<span class="op">=</span><span class="fl">0.02</span>            <span class="co"># population deviation (fraction from ideal)</span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="co"># initialize constraints </span></span>
<span id="cb16-16"><a href="#cb16-16"></a>constraints <span class="op">=</span> <span class="fu">initialize_constraints</span>()</span>
<span id="cb16-17"><a href="#cb16-17"></a><span class="co"># add population constraint </span></span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="fu">add_constraint!</span>(constraints, <span class="fu">PopulationConstraint</span>(graph, num_of_districts, </span>
<span id="cb16-19"><a href="#cb16-19"></a>                                                    allowed_pop_dev))</span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="co"># initialize a random initial partition</span></span>
<span id="cb16-21"><a href="#cb16-21"></a>rng <span class="op">=</span> PCG.<span class="fu">PCGStateOneseq</span>(<span class="dt">UInt64</span>, <span class="fl">4541901234</span>)    <span class="co"># initialize a random number generator </span></span>
<span id="cb16-22"><a href="#cb16-22"></a>partition <span class="op">=</span> <span class="fu">LinkCutPartition</span>(graph, constraints, num_of_districts; rng<span class="op">=</span>rng, </span>
<span id="cb16-23"><a href="#cb16-23"></a>                                verbose<span class="op">=</span><span class="cn">true</span>);</span>
<span id="cb16-24"><a href="#cb16-24"></a></span>
<span id="cb16-25"><a href="#cb16-25"></a>measure <span class="op">=</span> <span class="fu">Measure</span>()     <span class="co"># build measure</span></span>
<span id="cb16-26"><a href="#cb16-26"></a>gamma<span class="op">=</span><span class="fl">0.0</span>               <span class="co"># typically a number in [0,1]</span></span>
<span id="cb16-27"><a href="#cb16-27"></a>iso_weight<span class="op">=</span> <span class="fl">0.3</span>         <span class="co"># weight on the sum of isoperimetric ratios; i.e. Polsby-Popper</span></span>
<span id="cb16-28"><a href="#cb16-28"></a><span class="fu">push_energy!</span>(measure, get_log_spanning_forests, gamma) <span class="co"># add spanning forests energy</span></span>
<span id="cb16-29"><a href="#cb16-29"></a><span class="fu">push_energy!</span>(measure, get_isoperimetric_score, iso_weight) <span class="co"># add isoperimetric score energy</span></span>
<span id="cb16-30"><a href="#cb16-30"></a></span>
<span id="cb16-31"><a href="#cb16-31"></a>cycle_walk_2_tree <span class="op">=</span> <span class="fu">build_two_tree_cycle_walk</span>(constraints)</span>
<span id="cb16-32"><a href="#cb16-32"></a>cycle_walk_1_tree <span class="op">=</span> <span class="fu">build_one_tree_cycle_walk</span>(constraints)</span>
<span id="cb16-33"><a href="#cb16-33"></a>twocycle_frac<span class="op">=</span><span class="fl">0.1</span>   <span class="co"># fraction of 2-tree cycle walks among total walks</span></span>
<span id="cb16-34"><a href="#cb16-34"></a>proposal <span class="op">=</span> [(twocycle_frac, cycle_walk_2_tree), </span>
<span id="cb16-35"><a href="#cb16-35"></a>            (<span class="fl">1.0</span><span class="op">-</span>twocycle_frac, cycle_walk_1_tree)]</span>
<span id="cb16-36"><a href="#cb16-36"></a></span>
<span id="cb16-37"><a href="#cb16-37"></a><span class="co">#set output file name</span></span>
<span id="cb16-38"><a href="#cb16-38"></a>atlasName <span class="op">=</span> <span class="st">"cycleWalk"</span><span class="op">*</span><span class="st">"_hex10x10_"</span> <span class="op">*</span> <span class="st">"_gamma"</span> <span class="op">*</span> <span class="fu">string</span>(gamma)<span class="op">*</span><span class="st">"_kappa"</span></span>
<span id="cb16-39"><a href="#cb16-39"></a>atlasName<span class="op">*=</span> <span class="fu">string</span>(twocycle_frac)<span class="op">*</span><span class="st">"_iso"</span><span class="fu">*string</span>(iso_weight)<span class="op">*</span><span class="st">".jsonl"</span></span>
<span id="cb16-40"><a href="#cb16-40"></a></span>
<span id="cb16-41"><a href="#cb16-41"></a>output_file_path <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"output"</span>,<span class="st">"grid"</span>, atlasName) </span>
<span id="cb16-42"><a href="#cb16-42"></a></span>
<span id="cb16-43"><a href="#cb16-43"></a><span class="co"># create writer and open output atlas</span></span>
<span id="cb16-44"><a href="#cb16-44"></a>ad_param <span class="op">=</span> <span class="fu">Dict</span><span class="dt">{String, Any}</span>(<span class="st">"popdev"</span> <span class="op">=&gt;</span> allowed_pop_dev)   <span class="co"># specific info to write</span></span>
<span id="cb16-45"><a href="#cb16-45"></a>writer <span class="op">=</span> <span class="fu">Writer</span>(measure, constraints, partition, output_file_path; </span>
<span id="cb16-46"><a href="#cb16-46"></a>                additional_parameters<span class="op">=</span>ad_param)</span>
<span id="cb16-47"><a href="#cb16-47"></a><span class="fu">push_writer!</span>(writer, get_log_spanning_trees)        <span class="co"># add spanning trees count to writer</span></span>
<span id="cb16-48"><a href="#cb16-48"></a><span class="fu">push_writer!</span>(writer, get_log_spanning_forests)      <span class="co"># add spanning forests count to writer</span></span>
<span id="cb16-49"><a href="#cb16-49"></a><span class="fu">push_writer!</span>(writer, get_isoperimetric_scores)      <span class="co"># add isoperimetric scores to writer</span></span>
<span id="cb16-50"><a href="#cb16-50"></a></span>
<span id="cb16-51"><a href="#cb16-51"></a><span class="co"># Run the MCMC</span></span>
<span id="cb16-52"><a href="#cb16-52"></a>cycle_walk_2_tree_steps <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb16-53"><a href="#cb16-53"></a>steps <span class="op">=</span> <span class="fu">Int</span>(cycle_walk_2_tree_steps<span class="op">/</span>twocycle_frac)</span>
<span id="cb16-54"><a href="#cb16-54"></a>outfreq <span class="op">=</span> <span class="fu">Int</span>(<span class="fl">1</span><span class="op">/</span>twocycle_frac)</span>
<span id="cb16-55"><a href="#cb16-55"></a></span>
<span id="cb16-56"><a href="#cb16-56"></a><span class="fu">println</span>(<span class="st">"running mcmc; outputting here: "</span><span class="op">*</span> output_file_path)</span>
<span id="cb16-57"><a href="#cb16-57"></a><span class="fu">run_metropolis_hastings!</span>(partition, proposal, measure, steps, rng,</span>
<span id="cb16-58"><a href="#cb16-58"></a>                         writer<span class="op">=</span>writer, output_freq<span class="op">=</span>outfreq)</span>
<span id="cb16-59"><a href="#cb16-59"></a><span class="fu">close_writer</span>(writer) <span class="co"># close atlas</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The lines change are 7, 13, 14, 27, 29, 38 and 39. Of these the most important of the non-cosmetic changes is the introduction of the isoparmetric score in line 29.</p>
</section>
</section>
<section id="a-small-realistic-example-connecticut-congressional-districts." class="level3">
<h3 class="anchored" data-anchor-id="a-small-realistic-example-connecticut-congressional-districts.">A small realistic example: Connecticut Congressional Districts.</h3>
<p>We now consider a smaller but realistic example of generating district maps for Connecticut with five confusional districts. As before, we begin by downloading the needed JSON adjacency file for Connecticut.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>curl  https<span class="op">://</span>jonmjonm.github.io<span class="op">/</span>QGDocs<span class="op">/</span>Geo<span class="op">/</span>Adjacency<span class="op">/</span>CT_pct20.json <span class="op">-</span>o CT_pct20.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Pkg</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">activate</span>(<span class="st">"."</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">RandomNumbers</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CycleWalk</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>twocycle_frac <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> <span class="fl">0.0</span> <span class="co"># 0 is spanning forest measure, 1 is partition</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>iso_weight <span class="op">=</span> <span class="fl">0.3</span> <span class="co"># weight on the sum of isoperimetric ratios; i.e. Polsby-Popper</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>num_dists <span class="op">=</span> <span class="fl">5</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="pp">@assert</span> <span class="fl">0</span> <span class="op">â‰¤</span> twocycle_frac <span class="op">â‰¤</span> <span class="fl">1</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> PCG.<span class="fu">PCGStateOneseq</span>(<span class="dt">UInt64</span>, <span class="fl">4541901234</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>pop_dev <span class="op">=</span> <span class="fl">0.02</span> <span class="co"># population deviation (fraction from ideal)</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>cycle_walk_steps <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">4</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>steps <span class="op">=</span> <span class="fu">Int</span>(cycle_walk_steps<span class="op">/</span>twocycle_frac)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>outfreq <span class="op">=</span> <span class="fu">Int</span>(<span class="fl">400</span><span class="op">/</span>twocycle_frac)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">## build graph</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>pctGraphPath <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"."</span>,<span class="st">"CT_pct20.json"</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>nodeData <span class="op">=</span> <span class="fu">Set</span>([<span class="st">"COUNTY"</span>, <span class="st">"NAME"</span>, <span class="st">"POP20"</span>, <span class="st">"area"</span>, <span class="st">"border_length"</span>]);</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> <span class="fu">build_graph</span>(pctGraphPath, <span class="st">"POP20"</span>, <span class="st">"NAME"</span>, nodeData;</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>              area_col<span class="op">=</span><span class="st">"area"</span>, node_border_col<span class="op">=</span><span class="st">"border_length"</span>, </span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>              edge_perimeter_col<span class="op">=</span><span class="st">"length"</span>)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co">## build partition</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>constraints <span class="op">=</span> <span class="fu">initialize_constraints</span>()</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="fu">add_constraint!</span>(constraints, <span class="fu">PopulationConstraint</span>(graph, num_dists, pop_dev))</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>partition <span class="op">=</span> <span class="fu">LinkCutPartition</span>(graph, constraints, num_dists; rng<span class="op">=</span>rng, </span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>                             verbose<span class="op">=</span><span class="cn">true</span>);</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co">## build proposal</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>cycle_walk_2_tree <span class="op">=</span> <span class="fu">build_two_tree_cycle_walk</span>(constraints)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>cycle_walk_1_tree <span class="op">=</span> <span class="fu">build_one_tree_cycle_walk</span>(constraints)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>proposal <span class="op">=</span> [(twocycle_frac, cycle_walk_2_tree), </span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>            (<span class="fl">1.0</span><span class="op">-</span>twocycle_frac, cycle_walk_1_tree)]</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co">## build measure</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>measure <span class="op">=</span> <span class="fu">Measure</span>()</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="fu">push_energy!</span>(measure, get_log_spanning_forests, gamma) <span class="co"># add spanning forests energy</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="fu">push_energy!</span>(measure, get_isoperimetric_score, iso_weight) <span class="co"># add isoperimetric score energy</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="co">## establish output name and path</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>atlasName <span class="op">=</span> <span class="st">"cycleWalk_ct_kappa"</span><span class="fu">*string</span>(twocycle_frac)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>atlasName <span class="op">*=</span> <span class="st">"_gamma"</span><span class="fu">*string</span>(gamma)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>atlasName <span class="op">*=</span> <span class="st">"_iso"</span><span class="fu">*string</span>(iso_weight)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>atlasName <span class="op">*=</span> <span class="st">".jsonl.gz"</span> <span class="co"># or just ".jsonl" for an uncompressed output</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>output_file_path <span class="op">=</span> <span class="fu">joinpath</span>(<span class="st">"output"</span>,<span class="st">"ct"</span>, atlasName) <span class="co"># add output directory to path</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="co">## establish writer to which the output will be written</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>ad_param <span class="op">=</span> <span class="fu">Dict</span><span class="dt">{String, Any}</span>(<span class="st">"popdev"</span> <span class="op">=&gt;</span> pop_dev) <span class="co"># specific info to write</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>writer <span class="op">=</span> <span class="fu">Writer</span>(measure, constraints, partition, output_file_path; </span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>                additional_parameters<span class="op">=</span>ad_param)</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_log_spanning_trees) <span class="co"># add spanning trees count to writer</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_log_spanning_forests) <span class="co"># add spanning forests count to writer</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="fu">push_writer!</span>(writer, get_isoperimetric_scores) <span class="co"># add isoperimetric scores to writer</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="co">## run MCMC sampler</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"running mcmc; outputting here: "</span><span class="op">*</span> output_file_path)</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="fu">run_metropolis_hastings!</span>(partition, proposal, measure, steps, rng,</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>                         writer<span class="op">=</span>writer, output_freq<span class="op">=</span>outfreq)</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="fu">close_writer</span>(writer) <span class="co"># close atlas</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jonmjonm\.github\.io\/QGDocs\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>